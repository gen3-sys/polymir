<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Polymir Backend Test Interface</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 100%);
            color: #00ff00;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: #00ffff;
            text-shadow: 0 0 10px #00ffff;
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .panel {
            background: rgba(0, 255, 255, 0.05);
            border: 2px solid #00ffff;
            border-radius: 10px;
            padding: 20px;
        }

        .panel h2 {
            color: #ffff00;
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            color: #00ffff;
            margin-bottom: 5px;
            font-size: 0.9em;
        }

        input, select, textarea {
            width: 100%;
            padding: 10px;
            background: #0a0a0a;
            border: 1px solid #00ff00;
            color: #00ff00;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #00ffff;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.3);
        }

        button {
            padding: 12px 24px;
            background: linear-gradient(135deg, #00ff00 0%, #00aa00 100%);
            color: #000;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1em;
            margin-right: 10px;
            margin-top: 10px;
            transition: all 0.3s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 255, 0, 0.4);
        }

        button.secondary {
            background: linear-gradient(135deg, #00ffff 0%, #0088aa 100%);
        }

        button.danger {
            background: linear-gradient(135deg, #ff0000 0%, #aa0000 100%);
            color: #fff;
        }

        .output {
            background: #000;
            border: 1px solid #00ff00;
            border-radius: 5px;
            padding: 15px;
            min-height: 200px;
            max-height: 400px;
            overflow-y: auto;
            font-size: 0.85em;
            margin-top: 15px;
        }

        .output pre {
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .status {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            text-align: center;
            font-weight: bold;
        }

        .status.success {
            background: rgba(0, 255, 0, 0.2);
            border: 1px solid #00ff00;
        }

        .status.error {
            background: rgba(255, 0, 0, 0.2);
            border: 1px solid #ff0000;
            color: #ff0000;
        }

        .status.info {
            background: rgba(0, 255, 255, 0.2);
            border: 1px solid #00ffff;
        }

        .schematic-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .schematic-card {
            background: rgba(0, 255, 0, 0.1);
            border: 1px solid #00ff00;
            border-radius: 5px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .schematic-card:hover {
            background: rgba(0, 255, 0, 0.2);
            transform: scale(1.05);
        }

        .schematic-card h4 {
            color: #ffff00;
            margin-bottom: 5px;
        }

        .schematic-card .tags {
            font-size: 0.8em;
            color: #00ffff;
        }

        .log-entry {
            padding: 5px;
            margin-bottom: 3px;
            border-left: 3px solid #00ff00;
            padding-left: 10px;
        }

        .log-entry.error {
            border-left-color: #ff0000;
            color: #ff0000;
        }

        .log-entry.success {
            border-left-color: #00ff00;
        }

        .log-entry.info {
            border-left-color: #00ffff;
            color: #00ffff;
        }

        .config-display {
            font-size: 0.85em;
            line-height: 1.6;
        }

        .websocket-status {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .websocket-status.connected {
            background: #00ff00;
            box-shadow: 0 0 10px #00ff00;
        }

        .websocket-status.disconnected {
            background: #ff0000;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéÆ POLYMIR BACKEND TEST INTERFACE</h1>

        <div id="connectionStatus" class="status info">
            <span class="websocket-status disconnected"></span>
            Server: Not Connected | WebSocket: Disconnected
        </div>

        <div class="grid">
            <!-- Authentication Panel -->
            <div class="panel">
                <h2>üîê Authentication</h2>
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="username" value="alice" placeholder="Enter username">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="password" value="password123" placeholder="Enter password">
                </div>
                <button onclick="register()">Register</button>
                <button onclick="login()" class="secondary">Login</button>
                <button onclick="logout()" class="danger">Logout</button>

                <div class="output" id="authOutput">
                    <div class="log-entry info">Ready to authenticate...</div>
                </div>
            </div>

            <!-- Server Configuration -->
            <div class="panel">
                <h2>‚öôÔ∏è Server Configuration</h2>
                <div class="form-group">
                    <label>API URL</label>
                    <input type="text" id="apiUrl" value="http://localhost:3000">
                </div>
                <div class="form-group">
                    <label>WebSocket URL</label>
                    <input type="text" id="wsUrl" value="ws://localhost:3001">
                </div>
                <button onclick="testConnection()">Test Connection</button>
                <button onclick="connectWebSocket()" class="secondary">Connect WebSocket</button>

                <div class="output" id="configOutput">
                    <div class="config-display">
                        <strong>Test Accounts:</strong><br>
                        alice / password123 (High Trust)<br>
                        bob / password123 (Medium Trust)<br>
                        charlie / password123 (Low Trust)
                    </div>
                </div>
            </div>
        </div>

        <div class="grid">
            <!-- Schematic Upload -->
            <div class="panel">
                <h2>üì§ Upload Schematic</h2>
                <div class="form-group">
                    <label>Schematic Name</label>
                    <input type="text" id="schematicName" placeholder="My Awesome Build">
                </div>
                <div class="form-group">
                    <label>Tags (comma-separated)</label>
                    <input type="text" id="schematicTags" placeholder="building,house,small">
                </div>
                <div class="form-group">
                    <label>Schematic Data (JSON)</label>
                    <textarea id="schematicData" rows="6" placeholder='{"size":{"x":10,"y":10,"z":10},"blocks":[...]}'></textarea>
                </div>
                <button onclick="uploadSchematic()">Upload Schematic</button>
                <button onclick="generateRandomSchematic()" class="secondary">Generate Random</button>

                <div class="output" id="uploadOutput">
                    <div class="log-entry info">Ready to upload schematics...</div>
                </div>
            </div>

            <!-- Schematic Library -->
            <div class="panel">
                <h2>üìö Schematic Library</h2>
                <div class="form-group">
                    <label>Search</label>
                    <input type="text" id="searchTerm" placeholder="Search by name or tags...">
                </div>
                <button onclick="searchSchematics()">Search</button>
                <button onclick="loadAllSchematics()" class="secondary">Load All</button>
                <button onclick="clearSchematicList()" class="danger">Clear</button>

                <div class="schematic-list" id="schematicList">
                    <div style="grid-column: 1/-1; text-align: center; color: #666;">
                        No schematics loaded. Click "Load All" or "Search"
                    </div>
                </div>
            </div>
        </div>

        <div class="grid">
            <!-- Validation Testing -->
            <div class="panel">
                <h2>‚úÖ Validation Testing</h2>
                <div class="form-group">
                    <label>Event Type</label>
                    <select id="eventType">
                        <option value="schematic_placement">Schematic Placement</option>
                        <option value="chunk_modification">Chunk Modification</option>
                        <option value="block_placement">Block Placement</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Data CID (IPFS)</label>
                    <input type="text" id="dataCid" placeholder="QmXXXXXXX...">
                </div>
                <button onclick="requestValidation()">Request Validation</button>
                <button onclick="loadPendingValidations()" class="secondary">Load Pending</button>

                <div class="output" id="validationOutput">
                    <div class="log-entry info">Ready to test validation...</div>
                </div>
            </div>

            <!-- Real-time Updates -->
            <div class="panel">
                <h2>üî¥ Real-time Updates (WebSocket)</h2>
                <div class="form-group">
                    <label>Position (X, Y, Z)</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="number" id="posX" value="0" style="flex: 1;">
                        <input type="number" id="posY" value="0" style="flex: 1;">
                        <input type="number" id="posZ" value="0" style="flex: 1;">
                    </div>
                </div>
                <button onclick="sendPosition()">Send Position</button>
                <button onclick="subscribeMegachunk()" class="secondary">Subscribe Megachunk (0,0,0)</button>

                <div class="output" id="wsOutput">
                    <div class="log-entry info">WebSocket not connected</div>
                </div>
            </div>
        </div>

        <!-- Activity Log -->
        <div class="panel">
            <h2>üìã Activity Log</h2>
            <button onclick="clearLog()" class="danger">Clear Log</button>
            <div class="output" id="activityLog" style="max-height: 300px;">
                <div class="log-entry info">Application started</div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let authToken = null;
        let currentPlayer = null;
        let websocket = null;
        let loadedSchematics = [];

        const API_URL = () => document.getElementById('apiUrl').value;
        const WS_URL = () => document.getElementById('wsUrl').value;

        // Utility functions
        function log(message, type = 'info') {
            const logDiv = document.getElementById('activityLog');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.insertBefore(entry, logDiv.firstChild);

            // Limit log entries
            while (logDiv.children.length > 100) {
                logDiv.removeChild(logDiv.lastChild);
            }
        }

        function updateOutput(elementId, message, type = 'info') {
            const output = document.getElementById(elementId);
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.innerHTML = typeof message === 'object' ? `<pre>${JSON.stringify(message, null, 2)}</pre>` : message;
            output.insertBefore(entry, output.firstChild);
        }

        function updateConnectionStatus() {
            const status = document.getElementById('connectionStatus');
            const serverStatus = authToken ? 'Connected' : 'Not Connected';
            const wsStatus = websocket && websocket.readyState === WebSocket.OPEN ? 'Connected' : 'Disconnected';

            status.innerHTML = `
                <span class="websocket-status ${websocket && websocket.readyState === WebSocket.OPEN ? 'connected' : 'disconnected'}"></span>
                Server: ${serverStatus} | WebSocket: ${wsStatus}
            `;
            status.className = `status ${authToken ? 'success' : 'info'}`;
        }

        // API Functions
        async function apiCall(endpoint, method = 'GET', body = null) {
            const headers = {
                'Content-Type': 'application/json'
            };

            if (authToken) {
                headers['Authorization'] = `Bearer ${authToken}`;
            }

            const config = {
                method,
                headers
            };

            if (body) {
                config.body = JSON.stringify(body);
            }

            const response = await fetch(`${API_URL()}${endpoint}`, config);
            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error || `HTTP ${response.status}`);
            }

            return data;
        }

        // Authentication
        async function register() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            try {
                const data = await apiCall('/players/register', 'POST', { username, password });
                updateOutput('authOutput', `‚úÖ Registered successfully: ${data.player.username}`, 'success');
                log(`Registered user: ${username}`, 'success');
            } catch (error) {
                updateOutput('authOutput', `‚ùå Registration failed: ${error.message}`, 'error');
                log(`Registration failed: ${error.message}`, 'error');
            }
        }

        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            try {
                const data = await apiCall('/players/login', 'POST', { username, password });
                authToken = data.token || 'mock-token-for-testing';
                currentPlayer = data.player;

                updateOutput('authOutput', `‚úÖ Logged in as ${data.player.username} (Trust: ${data.player.trust_score.toFixed(2)})`, 'success');
                log(`Logged in: ${username}`, 'success');
                updateConnectionStatus();
            } catch (error) {
                updateOutput('authOutput', `‚ùå Login failed: ${error.message}`, 'error');
                log(`Login failed: ${error.message}`, 'error');
            }
        }

        function logout() {
            authToken = null;
            currentPlayer = null;
            updateOutput('authOutput', 'Logged out', 'info');
            log('Logged out', 'info');
            updateConnectionStatus();
        }

        // Server testing
        async function testConnection() {
            try {
                const response = await fetch(`${API_URL()}/health`);
                const data = await response.json();

                updateOutput('configOutput', data, 'success');
                log('Server connection successful', 'success');
            } catch (error) {
                updateOutput('configOutput', `‚ùå Connection failed: ${error.message}`, 'error');
                log(`Connection failed: ${error.message}`, 'error');
            }
        }

        // WebSocket
        function connectWebSocket() {
            try {
                websocket = new WebSocket(WS_URL());

                websocket.onopen = () => {
                    updateOutput('wsOutput', '‚úÖ WebSocket connected', 'success');
                    log('WebSocket connected', 'success');
                    updateConnectionStatus();

                    if (currentPlayer) {
                        websocket.send(JSON.stringify({
                            type: 'authenticate',
                            playerId: currentPlayer.player_id
                        }));
                    }
                };

                websocket.onmessage = (event) => {
                    const message = JSON.parse(event.data);
                    updateOutput('wsOutput', `üì® ${message.type}: ${JSON.stringify(message)}`, 'info');
                    log(`WebSocket message: ${message.type}`, 'info');
                };

                websocket.onclose = () => {
                    updateOutput('wsOutput', '‚ùå WebSocket disconnected', 'error');
                    log('WebSocket disconnected', 'error');
                    updateConnectionStatus();
                };

                websocket.onerror = (error) => {
                    updateOutput('wsOutput', `‚ùå WebSocket error: ${error}`, 'error');
                    log('WebSocket error', 'error');
                };
            } catch (error) {
                updateOutput('wsOutput', `‚ùå Connection failed: ${error.message}`, 'error');
                log(`WebSocket connection failed: ${error.message}`, 'error');
            }
        }

        function sendPosition() {
            if (!websocket || websocket.readyState !== WebSocket.OPEN) {
                updateOutput('wsOutput', '‚ùå WebSocket not connected', 'error');
                return;
            }

            const position = {
                x: parseFloat(document.getElementById('posX').value),
                y: parseFloat(document.getElementById('posY').value),
                z: parseFloat(document.getElementById('posZ').value)
            };

            websocket.send(JSON.stringify({
                type: 'position_update',
                position
            }));

            updateOutput('wsOutput', `üì§ Sent position: (${position.x}, ${position.y}, ${position.z})`, 'success');
        }

        function subscribeMegachunk() {
            if (!websocket || websocket.readyState !== WebSocket.OPEN) {
                updateOutput('wsOutput', '‚ùå WebSocket not connected', 'error');
                return;
            }

            websocket.send(JSON.stringify({
                type: 'subscribe_megachunk',
                megachunkId: 'megachunk:0,0,0'
            }));

            updateOutput('wsOutput', 'üì§ Subscribed to megachunk (0,0,0)', 'success');
        }

        // Schematics
        function generateRandomSchematic() {
            const names = ['Tower', 'House', 'Bridge', 'Castle', 'Garden', 'Statue'];
            const types = ['wood', 'stone', 'glass', 'metal'];

            const name = names[Math.floor(Math.random() * names.length)];
            const size = { x: 10, y: 10, z: 10 };
            const blocks = [];

            for (let i = 0; i < 50; i++) {
                blocks.push({
                    x: Math.floor(Math.random() * size.x),
                    y: Math.floor(Math.random() * size.y),
                    z: Math.floor(Math.random() * size.z),
                    type: types[Math.floor(Math.random() * types.length)]
                });
            }

            document.getElementById('schematicName').value = `${name} ${Math.floor(Math.random() * 1000)}`;
            document.getElementById('schematicTags').value = 'generated,test,random';
            document.getElementById('schematicData').value = JSON.stringify({ size, blocks }, null, 2);

            updateOutput('uploadOutput', '‚úÖ Generated random schematic', 'success');
        }

        async function uploadSchematic() {
            if (!authToken) {
                updateOutput('uploadOutput', '‚ùå Please login first', 'error');
                return;
            }

            const name = document.getElementById('schematicName').value;
            const tags = document.getElementById('schematicTags').value.split(',').map(t => t.trim());
            const dataStr = document.getElementById('schematicData').value;

            try {
                const data = JSON.parse(dataStr);
                const result = await apiCall('/schematics/upload', 'POST', { name, tags, data });

                updateOutput('uploadOutput', result, 'success');
                log(`Uploaded schematic: ${name}`, 'success');
            } catch (error) {
                updateOutput('uploadOutput', `‚ùå Upload failed: ${error.message}`, 'error');
                log(`Upload failed: ${error.message}`, 'error');
            }
        }

        async function searchSchematics() {
            const searchTerm = document.getElementById('searchTerm').value;

            try {
                const data = await apiCall(`/schematics/search?searchTerm=${encodeURIComponent(searchTerm)}`);
                displaySchematics(data.schematics);
                log(`Found ${data.schematics.length} schematics`, 'success');
            } catch (error) {
                updateOutput('uploadOutput', `‚ùå Search failed: ${error.message}`, 'error');
                log(`Search failed: ${error.message}`, 'error');
            }
        }

        async function loadAllSchematics() {
            try {
                const data = await apiCall('/schematics/search');
                displaySchematics(data.schematics);
                log(`Loaded ${data.schematics.length} schematics`, 'success');
            } catch (error) {
                log(`Failed to load schematics: ${error.message}`, 'error');
            }
        }

        function displaySchematics(schematics) {
            loadedSchematics = schematics;
            const listDiv = document.getElementById('schematicList');
            listDiv.innerHTML = '';

            if (schematics.length === 0) {
                listDiv.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: #666;">No schematics found</div>';
                return;
            }

            schematics.forEach(schematic => {
                const card = document.createElement('div');
                card.className = 'schematic-card';
                card.onclick = () => viewSchematic(schematic);

                card.innerHTML = `
                    <h4>${schematic.name}</h4>
                    <div class="tags">${schematic.tags.join(', ')}</div>
                    <div style="font-size: 0.7em; margin-top: 5px; color: #888;">
                        by ${schematic.creator_username || 'Unknown'}
                    </div>
                `;

                listDiv.appendChild(card);
            });
        }

        function viewSchematic(schematic) {
            updateOutput('uploadOutput', schematic, 'info');
            log(`Viewing schematic: ${schematic.name}`, 'info');
        }

        function clearSchematicList() {
            document.getElementById('schematicList').innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: #666;">No schematics loaded</div>';
            loadedSchematics = [];
        }

        // Validation
        async function requestValidation() {
            if (!authToken) {
                updateOutput('validationOutput', '‚ùå Please login first', 'error');
                return;
            }

            const eventType = document.getElementById('eventType').value;
            const dataCid = document.getElementById('dataCid').value || `Qm${Math.random().toString(36).substring(2, 15)}`;

            try {
                const data = await apiCall('/validation/request', 'POST', {
                    eventType,
                    eventDataCid: dataCid
                });

                updateOutput('validationOutput', data, 'success');
                log('Validation requested', 'success');
            } catch (error) {
                updateOutput('validationOutput', `‚ùå Request failed: ${error.message}`, 'error');
                log(`Validation request failed: ${error.message}`, 'error');
            }
        }

        async function loadPendingValidations() {
            if (!authToken) {
                updateOutput('validationOutput', '‚ùå Please login first', 'error');
                return;
            }

            try {
                const data = await apiCall('/validation/pending');
                updateOutput('validationOutput', data, 'info');
                log(`Found ${data.pending.length} pending validations`, 'success');
            } catch (error) {
                updateOutput('validationOutput', `‚ùå Failed: ${error.message}`, 'error');
                log(`Failed to load pending validations: ${error.message}`, 'error');
            }
        }

        function clearLog() {
            document.getElementById('activityLog').innerHTML = '<div class="log-entry info">Log cleared</div>';
        }

        // Initialize
        updateConnectionStatus();
        log('Test interface ready. Configure server URLs and click "Test Connection"', 'info');
    </script>
</body>
</html>

